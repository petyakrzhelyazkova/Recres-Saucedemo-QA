@echo off
setlocal EnableExtensions EnableDelayedExpansion
chcp 65001 >nul

:: ===========================
:: SmartGarage API test runner
:: - Runs Maven TestNG tests
:: - Generates Allure + Surefire HTML
:: - Writes timestamped reports\%RUNID%
:: - Opens report reliably (keeps window if double-clicked)
:: ===========================

set "SELF_DIR=%~dp0"
pushd "%SELF_DIR%"

:: Optional args: %1 baseUrl  %2 adminUserName  %3 userPass  %4 wrongPass  %5 groups  %6 test filter
set "P_BASEURL=%~1"
set "P_ADMIN=%~2"
set "P_PASS=%~3"
set "P_WRONG=%~4"
set "P_GROUPS=%~5"
set "P_TEST=%~6"

where mvn >nul 2>nul || (echo Maven not found& popd & exit /b 10)

for /f "usebackq delims=" %%T in (`powershell -NoProfile -Command "(Get-Date).ToString('yyyyMMdd_HHmmss')"`) do set "RUNID=%%T"
if not defined RUNID (
  set "RUNID=%DATE:/=-%_%TIME::=%"
  set "RUNID=!RUNID: =0!"
  set "RUNID=!RUNID:.=!"
)

set "OUT_BASE=%SELF_DIR%reports\%RUNID%"
set "OUT_ALLURE=%OUT_BASE%\allure"
set "OUT_SUREFIRE=%OUT_BASE%\surefire"
mkdir "%OUT_ALLURE%" 2>nul
mkdir "%OUT_SUREFIRE%" 2>nul

set "MVN_ARGS=-DskipTests=false"
if defined P_BASEURL set "MVN_ARGS=%MVN_ARGS% -DbaseUrl=%P_BASEURL%"
if defined P_ADMIN   set "MVN_ARGS=%MVN_ARGS% -DadminUserName=%P_ADMIN%"
if defined P_PASS    set "MVN_ARGS=%MVN_ARGS% -DuserPass=%P_PASS%"
if defined P_WRONG   set "MVN_ARGS=%MVN_ARGS% -DwrongPass=%P_WRONG%"
if defined P_GROUPS  set "MVN_ARGS=%MVN_ARGS% -Dgroups=%P_GROUPS%"
if defined P_TEST    set "MVN_ARGS=%MVN_ARGS% -Dtest=%P_TEST%"

echo === mvn clean test %MVN_ARGS%
call mvn clean test %MVN_ARGS%
set "TEST_EXIT=%ERRORLEVEL%"

:: Create Surefire HTML (fallback)
call mvn -q surefire-report:report
if exist "target\surefire-reports" xcopy /e /i /y "target\surefire-reports" "%OUT_SUREFIRE%" >nul
if exist "target\site\surefire-report.html" copy /y "target\site\surefire-report.html" "%OUT_SUREFIRE%\index.html" >nul

:: Detect Allure results
set "HAVE_ALLURE_RESULTS=0"
for %%F in (target\allure-results\*.json) do (
  set "HAVE_ALLURE_RESULTS=1"
  goto :_have_results
)
:_have_results

:: Find Allure CLI
set "ALLURE_CMD="
where allure >nul 2>nul && set "ALLURE_CMD=allure"
if not defined ALLURE_CMD ( where npx >nul 2>nul && set "ALLURE_CMD=npx allure" )

:: Generate Allure and OPEN it in a new console window (so this script can finish)
if "%HAVE_ALLURE_RESULTS%"=="1" if defined ALLURE_CMD (
  call %ALLURE_CMD% generate "target\allure-results" -o "%OUT_ALLURE%" --clean
  if exist "%OUT_ALLURE%\index.html" (
    start "Allure Report" "%ComSpec%" /k call %ALLURE_CMD% open "%OUT_ALLURE%"
    goto :_maybe_pause
  )
)

:: Fallbacks: open Surefire HTML, else open the reports folder
if exist "%OUT_SUREFIRE%\index.html" (
  start "" "%OUT_SUREFIRE%\index.html"
) else if exist "%OUT_BASE%" (
  start "" "%OUT_BASE%"
)

:_maybe_pause
:: Keep the window open when launched by double-click (Explorer runs cmd.exe /c ...)
set "LAUNCHED_BY_EXPLORER=0"
echo %cmdcmdline% | find /I "/c" >nul && set "LAUNCHED_BY_EXPLORER=1"
if "%LAUNCHED_BY_EXPLORER%"=="1" (
  echo.
  echo Press any key to close this window...
  pause >nul
)

popd
exit /b %TEST_EXIT%
